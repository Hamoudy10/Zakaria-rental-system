# NOTIFICATION SYSTEM FIXES - COMPREHENSIVE GUIDE

## Overview

This guide contains all the updates needed to implement complete notification coverage across your Zakaria Rental System.

---

## Missing Notifications Identified

| Event | Current State | Fix File |
|-------|--------------|----------|
| New Tenant Created | ❌ Missing | `01_tenantController_UPDATE.js` |
| Tenant Allocated | ❌ Missing | `02_allocationController_UPDATE.js` |
| Tenant Deallocated | ❌ Missing | `02_allocationController_UPDATE.js` |
| Complaint Created | ❌ Missing | `03_complaintController_UPDATE.js` |
| Complaint Status Changed | ❌ Missing | `03_complaintController_UPDATE.js` |
| Complaint Assigned | ❌ Missing | `03_complaintController_UPDATE.js` |
| Water Bill Created | ❌ Missing | `04_waterBillController_UPDATE.js` |
| Expense Created | ❌ Missing | `05_expenses_route_UPDATE.js` |
| Expense Approved/Rejected | ❌ Missing | `05_expenses_route_UPDATE.js` |
| Lease Expiring Soon | ❌ Missing | `06_cronService_UPDATE.js` |
| Rent Overdue | ❌ Missing | `06_cronService_UPDATE.js` |

---

## How to Apply Each Fix

### Step 1: Add Import Statement

For each controller file, ensure this import is at the top:

```javascript
const NotificationService = require('../services/notificationService');
```

### Step 2: Find the Insertion Point

Each fix file shows exactly where to add the code with markers like:

```javascript
// ========== ADD AFTER THIS LINE ==========
// Your existing code here...

// >>>>>>>>>> START: NOTIFICATION CODE TO ADD <<<<<<<<<<
// New notification code
// >>>>>>>>>> END: NOTIFICATION CODE TO ADD <<<<<<<<<<
```

### Step 3: Copy the Notification Code

Copy only the code between the `START` and `END` markers into your actual file.

### Step 4: Test Each Notification

After adding each fix, test by:
1. Triggering the event (e.g., create a tenant)
2. Check the notification bell for admins/agents
3. Verify the notification appears correctly

---

## Quick Reference: Who Gets Notified

| Event | Admin | Agent | Tenant |
|-------|-------|-------|--------|
| New Tenant Created | ✅ | ❌ | ❌ |
| Tenant Allocated | ✅ | ✅ (assigned) | ❌ |
| Tenant Deallocated | ✅ | ✅ (assigned) | ❌ |
| Complaint Created | ✅ | ✅ (assigned) | ❌ |
| Complaint Status Changed | ❌ | ❌ | ✅ |
| Complaint Assigned | ❌ | ✅ (assigned) | ❌ |
| Water Bill Created | ✅ | ❌ | ✅ (via SMS) |
| Expense Created | ✅ | ❌ | ❌ |
| Expense Approved | ❌ | ✅ (recorder) | ❌ |
| Expense Rejected | ❌ | ✅ (recorder) | ❌ |
| Lease Expiring | ✅ | ✅ (assigned) | ✅ |
| Rent Overdue | ✅ | ✅ (assigned) | ✅ |

---

## File-by-File Instructions

### 1. Tenant Controller (`backend/controllers/tenantController.js`)

**File:** `01_tenantController_UPDATE.js`

**What it does:** Notifies admins when a new tenant is created.

**Where to add:** Inside `createTenant` function, after successful tenant creation.

---

### 2. Allocation Controller (`backend/controllers/allocationController.js`)

**File:** `02_allocationController_UPDATE.js`

**What it does:** 
- Notifies admins + assigned agent when tenant is allocated
- Notifies admins + assigned agent when tenant is deallocated

**Where to add:** 
- In `createAllocation` function after successful allocation
- In `updateAllocation` function when `is_active` changes to false

---

### 3. Complaint Controller (`backend/controllers/complaintController.js`)

**File:** `03_complaintController_UPDATE.js`

**What it does:**
- Notifies admins + assigned agent when complaint is created
- Notifies tenant when complaint status changes
- Notifies agent when complaint is assigned to them

**Where to add:**
- In `createComplaint` function after successful creation
- In `updateComplaint` function after successful update

---

### 4. Water Bill Controller (`backend/controllers/waterBillController.js`)

**File:** `04_waterBillController_UPDATE.js`

**What it does:** Notifies admins when water bill is created (tenant gets SMS separately).

**Where to add:** In `createWaterBill` function after successful creation.

---

### 5. Expenses Route (`backend/routes/expenses.js`)

**File:** `05_expenses_route_UPDATE.js`

**What it does:**
- Notifies admins when new expense is recorded
- Notifies the agent when their expense is approved/rejected

**Where to add:**
- In POST `/` route after successful expense creation
- In PATCH `/:id/status` route after status update

---

### 6. Cron Service (`backend/services/cronService.js`)

**File:** `06_cronService_UPDATE.js`

**What it does:**
- Daily check for leases expiring in 30 days
- Daily check for overdue rent payments
- Sends notifications to relevant users

**Where to add:** Add new methods and schedule them in the `start()` method.

---

### 7. Notification Service (`backend/services/notificationService.js`)

**File:** `07_notificationService_UPDATE.js`

**What it does:** Adds new helper methods for the notification types above.

**Where to add:** Add the new static methods to the NotificationService class.

---

## Testing Checklist

After applying all fixes, test each notification:

- [ ] Create a new tenant → Admin should see notification
- [ ] Allocate tenant to unit → Admin + Agent should see notification
- [ ] Deallocate tenant → Admin + Agent should see notification
- [ ] Create complaint → Admin + Agent should see notification
- [ ] Update complaint status → Tenant should see notification
- [ ] Assign complaint to agent → Agent should see notification
- [ ] Create water bill → Admin should see notification
- [ ] Create expense → Admin should see notification
- [ ] Approve expense → Agent should see notification
- [ ] Reject expense → Agent should see notification
- [ ] Wait for cron (or trigger manually) → Check lease/overdue notifications

---

## Troubleshooting

### Notification not appearing?

1. Check browser console for errors
2. Check backend logs for notification creation errors
3. Verify the user ID is correct (must be from `users` table, not `tenants`)
4. Check if NotificationService import is correct

### Rate limiting (429 errors)?

The NotificationContext already handles this with exponential backoff. If you see 429 errors:
1. Reduce polling frequency (increase `backoffRef.current` initial value)
2. Batch notifications where possible

### Wrong user receiving notification?

Remember:
- `tenants` table is for renters (no login, SMS only)
- `users` table is for admins/agents (in-app notifications)
- Never use `tenant_id` for in-app notifications

---

## Deployment Steps

1. Apply all fixes locally
2. Test each notification type
3. Commit changes
4. Deploy to Render
5. Test in production

---

## Support

If you encounter issues:
1. Check the specific fix file for context
2. Verify the insertion point is correct
3. Ensure all imports are present
4. Check backend logs for errors