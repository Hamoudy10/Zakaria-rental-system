// src/utils/pdfExport.js
// COMPLETE PDF EXPORT UTILITY - Handles all report types including tenant payment status

/**
 * Export data to PDF
 * @param {Object} config - Export configuration
 * @param {string} config.reportType - Type of report (payments, tenants, unpaid_tenants, paid_tenants, etc.)
 * @param {Array} config.data - Data to export
 * @param {Object} config.filters - Applied filters
 * @param {Object} config.companyInfo - Company information
 * @param {Object} config.user - Current user
 * @param {string} config.title - Report title
 */
export const exportToPDF = async (config) => {
  const { reportType, data, filters, companyInfo, user, title } = config;

  if (!data || data.length === 0) {
    throw new Error("No data to export");
  }

  try {
    // Dynamic import jsPDF
    const jspdfModule = await import("jspdf");
    const jsPDF = jspdfModule.jsPDF || jspdfModule.default;

    // Dynamic import autoTable
    const autoTableModule = await import("jspdf-autotable");
    const autoTable = autoTableModule.default;

    // Create new document
    const doc = new jsPDF("landscape", "mm", "a4");
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    // ========================================
    // HEADER SECTION
    // ========================================
    let yPosition = 15;

    // Company logo (if available)
    if (companyInfo?.logo) {
      try {
        doc.addImage(companyInfo.logo, "PNG", 14, 10, 25, 25);
        yPosition = 40;
      } catch (e) {
        console.warn("Could not add company logo:", e);
      }
    }

    // Company name
    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(44, 62, 80);
    doc.text(
      companyInfo?.name || "Zakaria Housing Agency",
      pageWidth / 2,
      yPosition,
      { align: "center" },
    );
    yPosition += 8;

    // Company contact info
    if (companyInfo?.address || companyInfo?.phone || companyInfo?.email) {
      doc.setFontSize(9);
      doc.setFont("helvetica", "normal");
      doc.setTextColor(100, 100, 100);
      const contactInfo = [
        companyInfo.address,
        companyInfo.phone,
        companyInfo.email,
      ]
        .filter(Boolean)
        .join(" | ");
      doc.text(contactInfo, pageWidth / 2, yPosition, { align: "center" });
      yPosition += 6;
    }

    // Report title
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(52, 73, 94);
    doc.text(
      title || `${reportType.replace(/_/g, " ").toUpperCase()} REPORT`,
      pageWidth / 2,
      yPosition + 5,
      { align: "center" },
    );
    yPosition += 12;

    // Divider line
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
    doc.line(14, yPosition, pageWidth - 14, yPosition);
    yPosition += 5;

    // Filter info and generation details
    doc.setFontSize(8);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(100, 100, 100);

    const generatedDate = new Date().toLocaleString("en-GB", {
      dateStyle: "medium",
      timeStyle: "short",
    });
    doc.text(`Generated: ${generatedDate}`, 14, yPosition);
    doc.text(
      `Generated by: ${user?.first_name || ""} ${user?.last_name || ""} (${user?.role || "User"})`,
      pageWidth - 14,
      yPosition,
      { align: "right" },
    );
    yPosition += 5;

    // Filter summary
    const filterParts = [];
    if (filters?.month) filterParts.push(`Month: ${filters.month}`);
    if (filters?.propertyId) filterParts.push(`Property: Filtered`);
    if (filters?.period)
      filterParts.push(`Period: ${filters.period.replace("_", " ")}`);
    if (filters?.startDate && filters?.endDate) {
      filterParts.push(
        `Date Range: ${filters.startDate} to ${filters.endDate}`,
      );
    }

    if (filterParts.length > 0) {
      doc.text(`Filters: ${filterParts.join(" | ")}`, 14, yPosition);
      yPosition += 5;
    }

    yPosition += 5;

    // ========================================
    // TABLE DATA BASED ON REPORT TYPE
    // ========================================
    const { head, body, columnStyles } = getTableConfig(reportType, data);

    // Generate table
    autoTable(doc, {
      startY: yPosition,
      head: [head],
      body: body,
      theme: "grid",
      styles: {
        fontSize: 8,
        cellPadding: 3,
        overflow: "linebreak",
        halign: "left",
      },
      headStyles: {
        fillColor: [52, 73, 94],
        textColor: [255, 255, 255],
        fontStyle: "bold",
        halign: "center",
      },
      alternateRowStyles: {
        fillColor: [248, 249, 250],
      },
      columnStyles: columnStyles,
      margin: { left: 14, right: 14 },
      didDrawPage: (data) => {
        // Footer on each page
        const pageCount = doc.internal.getNumberOfPages();
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(
          `Page ${data.pageNumber} of ${pageCount}`,
          pageWidth / 2,
          pageHeight - 10,
          { align: "center" },
        );
        doc.text(
          companyInfo?.name || "Zakaria Housing Agency",
          14,
          pageHeight - 10,
        );
      },
    });

    // ========================================
    // SUMMARY SECTION (if applicable)
    // ========================================
    const finalY = doc.lastAutoTable.finalY + 10;

    if (reportType === "unpaid_tenants" || reportType === "paid_tenants") {
      addTenantStatusSummary(doc, data, finalY, reportType);
    } else if (reportType === "payments") {
      addPaymentSummary(doc, data, finalY);
    }

    // Save the PDF
    const fileName = `${reportType}_report_${new Date().toISOString().split("T")[0]}.pdf`;
    doc.save(fileName);

    console.log(`✅ PDF exported successfully: ${fileName}`);
    return { success: true, fileName };
  } catch (error) {
    console.error("❌ PDF export error:", error);
    throw new Error(`PDF export failed: ${error.message}`);
  }
};

/**
 * Get table configuration based on report type
 */
function getTableConfig(reportType, data) {
  let head = [];
  let body = [];
  let columnStyles = {};

  switch (reportType) {
    case "unpaid_tenants":
    case "paid_tenants":
      // Check if data uses object keys (from handleExportTenantStatus)
      if (data[0] && data[0]["Tenant Name"] !== undefined) {
        head = [
          "Tenant Name",
          "Property",
          "Unit",
          "Phone",
          "Monthly Rent",
          "Rent Paid",
          "Rent Due",
          "Water Bill",
          "Arrears",
          "Total Due",
          "Status",
        ];
        body = data.map((row) => [
          row["Tenant Name"] || "N/A",
          row["Property"] || "N/A",
          row["Unit"] || "N/A",
          row["Phone"] || "N/A",
          formatCurrency(row["Monthly Rent"]),
          formatCurrency(row["Rent Paid"]),
          formatCurrency(row["Rent Due"]),
          formatCurrency(row["Water Bill"]),
          formatCurrency(row["Arrears"]),
          formatCurrency(row["Total Due"]),
          row["Status"] || "N/A",
        ]);
      } else {
        // Raw data format
        head = [
          "Tenant Name",
          "Property",
          "Unit",
          "Phone",
          "Monthly Rent",
          "Rent Paid",
          "Rent Due",
          "Water Bill",
          "Arrears",
          "Total Due",
          "Status",
        ];
        body = data.map((row) => [
          row.tenant_name ||
            `${row.first_name || ""} ${row.last_name || ""}`.trim() ||
            "N/A",
          row.property_name || "N/A",
          row.unit_code || "N/A",
          formatPhone(row.phone_number),
          formatCurrency(row.monthly_rent),
          formatCurrency(row.rent_paid),
          formatCurrency(row.rent_due),
          formatCurrency(row.water_bill),
          formatCurrency(row.arrears),
          formatCurrency(row.total_due),
          row.total_due <= 0 ? "Paid" : "Unpaid",
        ]);
      }
      columnStyles = {
        0: { cellWidth: 35 },
        1: { cellWidth: 30 },
        2: { cellWidth: 20 },
        3: { cellWidth: 25 },
        4: { cellWidth: 25, halign: "right" },
        5: { cellWidth: 25, halign: "right" },
        6: { cellWidth: 25, halign: "right" },
        7: { cellWidth: 25, halign: "right" },
        8: { cellWidth: 25, halign: "right" },
        9: { cellWidth: 25, halign: "right" },
        10: { cellWidth: 20, halign: "center" },
      };
      break;

    case "payments":
      head = [
        "Tenant",
        "Property",
        "Unit",
        "Amount",
        "Receipt",
        "Month",
        "Date",
        "Status",
      ];
      body = data.map((row) => [
        row.tenant_name ||
          `${row.first_name || ""} ${row.last_name || ""}`.trim() ||
          "N/A",
        row.property_name || "N/A",
        row.unit_code || "N/A",
        formatCurrency(row.amount),
        row.mpesa_receipt_number || row.mpesa_transaction_id || "N/A",
        row.payment_month || "N/A",
        formatDate(row.payment_date || row.created_at),
        row.status || "N/A",
      ]);
      columnStyles = {
        0: { cellWidth: 40 },
        1: { cellWidth: 35 },
        2: { cellWidth: 20 },
        3: { cellWidth: 30, halign: "right" },
        4: { cellWidth: 35 },
        5: { cellWidth: 25 },
        6: { cellWidth: 25 },
        7: { cellWidth: 20, halign: "center" },
      };
      break;

    case "tenants":
      head = [
        "Name",
        "Phone",
        "Property",
        "Unit",
        "Rent",
        "Lease Start",
        "Status",
      ];
      body = data.map((row) => [
        row.tenant_name ||
          `${row.first_name || ""} ${row.last_name || ""}`.trim() ||
          "N/A",
        formatPhone(row.phone_number),
        row.property_name || "N/A",
        row.unit_code || "N/A",
        formatCurrency(row.monthly_rent || row.rent_amount),
        formatDate(row.lease_start_date || row.allocation_date),
        row.is_active ? "Active" : row.status || "Inactive",
      ]);
      columnStyles = {
        0: { cellWidth: 45 },
        1: { cellWidth: 30 },
        2: { cellWidth: 40 },
        3: { cellWidth: 25 },
        4: { cellWidth: 30, halign: "right" },
        5: { cellWidth: 30 },
        6: { cellWidth: 25, halign: "center" },
      };
      break;

    case "sms":
      head = ["Recipient", "Message", "Type", "Channel", "Status", "Date"];
      body = data.map((row) => [
        formatPhone(row.recipient_phone),
        (row.message || "").substring(0, 50) +
          (row.message?.length > 50 ? "..." : ""),
        row.message_type || "General",
        row.channel || "SMS",
        row.status || "Pending",
        formatDate(row.created_at),
      ]);
      columnStyles = {
        0: { cellWidth: 30 },
        1: { cellWidth: 80 },
        2: { cellWidth: 30 },
        3: { cellWidth: 25 },
        4: { cellWidth: 25, halign: "center" },
        5: { cellWidth: 30 },
      };
      break;

    case "water":
      head = ["Tenant", "Property", "Unit", "Amount", "Bill Month", "Status"];
      body = data.map((row) => [
        row.tenant_name ||
          `${row.first_name || ""} ${row.last_name || ""}`.trim() ||
          "N/A",
        row.property_name || "N/A",
        row.unit_code || "N/A",
        formatCurrency(row.amount),
        row.bill_month || "N/A",
        row.status || "Pending",
      ]);
      columnStyles = {
        0: { cellWidth: 45 },
        1: { cellWidth: 45 },
        2: { cellWidth: 25 },
        3: { cellWidth: 35, halign: "right" },
        4: { cellWidth: 35 },
        5: { cellWidth: 30, halign: "center" },
      };
      break;

    case "complaints":
      head = ["Title", "Property", "Unit", "Priority", "Status", "Date"];
      body = data.map((row) => [
        row.title || "N/A",
        row.property_name || "N/A",
        row.unit_code || "N/A",
        row.priority || "Medium",
        row.status || "Open",
        formatDate(row.raised_at || row.created_at),
      ]);
      columnStyles = {
        0: { cellWidth: 60 },
        1: { cellWidth: 45 },
        2: { cellWidth: 25 },
        3: { cellWidth: 25, halign: "center" },
        4: { cellWidth: 30, halign: "center" },
        5: { cellWidth: 30 },
      };
      break;

    case "properties":
      head = [
        "Code",
        "Name",
        "Address",
        "Total Units",
        "Occupied",
        "Available",
      ];
      body = data.map((row) => [
        row.property_code || "N/A",
        row.name || "N/A",
        row.address || "N/A",
        row.total_units || row.unit_count || 0,
        row.occupied_units || 0,
        row.available_units || 0,
      ]);
      columnStyles = {
        0: { cellWidth: 25 },
        1: { cellWidth: 50 },
        2: { cellWidth: 70 },
        3: { cellWidth: 30, halign: "center" },
        4: { cellWidth: 30, halign: "center" },
        5: { cellWidth: 30, halign: "center" },
      };
      break;

    case "revenue":
      head = [
        "Month",
        "Total Revenue",
        "Payments",
        "Properties",
        "Tenants",
        "Avg Payment",
      ];
      body = data.map((row) => [
        row.month || "N/A",
        formatCurrency(row.total_revenue),
        row.payment_count || 0,
        row.property_count || 0,
        row.tenant_count || 0,
        formatCurrency(row.average_payment),
      ]);
      columnStyles = {
        0: { cellWidth: 35 },
        1: { cellWidth: 40, halign: "right" },
        2: { cellWidth: 30, halign: "center" },
        3: { cellWidth: 30, halign: "center" },
        4: { cellWidth: 30, halign: "center" },
        5: { cellWidth: 40, halign: "right" },
      };
      break;

    default:
      // Generic table for unknown report types
      if (data.length > 0) {
        const firstRow = data[0];
        head = Object.keys(firstRow).slice(0, 8); // Limit to 8 columns
        body = data.map((row) =>
          head.map((key) => {
            const value = row[key];
            if (typeof value === "number") {
              return value.toLocaleString();
            }
            return String(value || "N/A").substring(0, 40);
          }),
        );
      }
      break;
  }

  return { head, body, columnStyles };
}

/**
 * Parse currency string or number to numeric value
 */
function parseCurrencyValue(value) {
  if (typeof value === "number") return value;
  if (typeof value === "string") {
    // Remove KSh, commas, spaces and parse
    const cleaned = value.replace(/[KSh,\s]/g, "").trim();
    return parseFloat(cleaned) || 0;
  }
  return 0;
}

/**
 * Add tenant status summary to PDF
 */
function addTenantStatusSummary(doc, data, yPosition, reportType) {
  const pageWidth = doc.internal.pageSize.getWidth();

  // Calculate summary
  let totalExpected = 0;
  let totalPaid = 0;
  let totalOutstanding = 0;

  data.forEach((row) => {
    const monthlyRent = parseCurrencyValue(
      row["Monthly Rent"] || row.monthly_rent || 0,
    );
    const rentPaid = parseCurrencyValue(row["Rent Paid"] || row.rent_paid || 0);
    const totalDue = parseCurrencyValue(row["Total Due"] || row.total_due || 0);

    totalExpected += monthlyRent;
    totalPaid += rentPaid;
    totalOutstanding += totalDue;
  });

  doc.setFontSize(10);
  doc.setFont("helvetica", "bold");
  doc.setTextColor(52, 73, 94);
  doc.text("SUMMARY", 14, yPosition);

  yPosition += 7;
  doc.setFontSize(9);
  doc.setFont("helvetica", "normal");
  doc.setTextColor(60, 60, 60);

  const summaryData = [
    ["Total Tenants:", data.length.toString()],
    ["Total Expected:", formatCurrency(totalExpected)],
    ["Total Paid:", formatCurrency(totalPaid)],
    ["Total Outstanding:", formatCurrency(totalOutstanding)],
  ];

  summaryData.forEach(([label, value], index) => {
    doc.text(label, 14, yPosition + index * 5);
    doc.text(value, 60, yPosition + index * 5);
  });
}

/**
 * Add payment summary to PDF
 */
function addPaymentSummary(doc, data, yPosition) {
  const totalAmount = data.reduce(
    (sum, row) => sum + parseFloat(row.amount || 0),
    0,
  );
  const completedCount = data.filter(
    (row) => row.status === "completed",
  ).length;

  doc.setFontSize(10);
  doc.setFont("helvetica", "bold");
  doc.setTextColor(52, 73, 94);
  doc.text("SUMMARY", 14, yPosition);

  yPosition += 7;
  doc.setFontSize(9);
  doc.setFont("helvetica", "normal");

  doc.text(`Total Transactions: ${data.length}`, 14, yPosition);
  doc.text(`Completed: ${completedCount}`, 14, yPosition + 5);
  doc.text(`Total Amount: ${formatCurrency(totalAmount)}`, 14, yPosition + 10);
}

// ========================================
// HELPER FUNCTIONS
// ========================================

function formatCurrency(amount) {
  // If already formatted as string with KSh, return as-is
  if (typeof amount === "string" && amount.includes("KSh")) {
    return amount;
  }
  // If it's a formatted number string like "15,000", extract the number
  if (typeof amount === "string" && amount.includes(",")) {
    const cleaned = amount.replace(/[^0-9.-]/g, "");
    const num = parseFloat(cleaned) || 0;
    return `KSh ${num.toLocaleString("en-KE")}`;
  }
  // Regular number parsing
  const num = parseFloat(amount) || 0;
  return `KSh ${num.toLocaleString("en-KE")}`;
}

function formatDate(dateString) {
  if (!dateString) return "N/A";
  try {
    return new Date(dateString).toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    });
  } catch {
    return "N/A";
  }
}

function formatPhone(phone) {
  if (!phone) return "N/A";
  return phone.toString().replace(/^254/, "0");
}

export default exportToPDF;
